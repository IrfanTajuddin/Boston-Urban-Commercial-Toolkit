<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Urban Commercial Diagnostic Toolkit</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --bg: #0e0e0e;
  --surface: #161616;
  --surface2: #1e1e1e;
  --border: #2a2a2a;
  --text: #e8e4dc;
  --text-muted: #7a7570;
  --text-dim: #4a4540;
  --amber: #d4854a;
  --amber-light: #e8a870;
  --amber-dim: #6b3f1f;
  --red: #c94040;
  --blue: #4a7ab5;
  --green: #5a9b6e;
  --gold: #c9a84c;
  --font-display: 'Playfair Display', Georgia, serif;
  --font-body: 'DM Sans', sans-serif;
  --font-mono: 'DM Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  font-weight: 300;
  line-height: 1.7;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ */
nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1.2rem 3rem;
  background: rgba(14,14,14,0.92);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
}

.nav-logo {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--amber);
  letter-spacing: 0.15em;
  text-transform: uppercase;
}

.nav-links {
  display: flex;
  gap: 2.5rem;
  list-style: none;
}

.nav-links a {
  color: var(--text-muted);
  text-decoration: none;
  font-size: 0.8rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  transition: color 0.2s;
}

.nav-links a:hover { color: var(--amber); }

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 8rem 3rem 4rem;
  position: relative;
  overflow: hidden;
}

.hero-grid {
  position: absolute;
  inset: 0;
  background-image:
    linear-gradient(var(--border) 1px, transparent 1px),
    linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size: 60px 60px;
  opacity: 0.3;
  mask-image: radial-gradient(ellipse 80% 60% at 50% 50%, black, transparent);
}

.hero-glow {
  position: absolute;
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(212,133,74,0.08) 0%, transparent 70%);
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.hero-content {
  position: relative;
  max-width: 900px;
}

.hero-tag {
  font-family: var(--font-mono);
  font-size: 0.72rem;
  color: var(--amber);
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 1.5rem;
  opacity: 0;
  animation: fadeUp 0.8s ease forwards 0.2s;
}

.hero h1 {
  font-family: var(--font-display);
  font-size: clamp(2.8rem, 6vw, 5.5rem);
  font-weight: 900;
  line-height: 1.05;
  letter-spacing: -0.02em;
  margin-bottom: 1.5rem;
  opacity: 0;
  animation: fadeUp 0.8s ease forwards 0.4s;
}

.hero h1 em {
  font-style: italic;
  color: var(--amber);
}

.hero-sub {
  font-size: 1.05rem;
  color: var(--text-muted);
  max-width: 560px;
  margin-bottom: 3rem;
  opacity: 0;
  animation: fadeUp 0.8s ease forwards 0.6s;
}

.hero-cta {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  opacity: 0;
  animation: fadeUp 0.8s ease forwards 0.8s;
}

.btn-primary {
  background: var(--amber);
  color: #0e0e0e;
  padding: 0.85rem 2rem;
  border: none;
  font-family: var(--font-body);
  font-size: 0.85rem;
  font-weight: 500;
  letter-spacing: 0.05em;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
  transition: background 0.2s, transform 0.2s;
}

.btn-primary:hover { background: var(--amber-light); transform: translateY(-1px); }

.btn-secondary {
  background: transparent;
  color: var(--text-muted);
  padding: 0.85rem 2rem;
  border: 1px solid var(--border);
  font-family: var(--font-body);
  font-size: 0.85rem;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
  transition: border-color 0.2s, color 0.2s;
}

.btn-secondary:hover { border-color: var(--amber); color: var(--amber); }

.hero-stats {
  position: absolute;
  right: 3rem;
  bottom: 4rem;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  opacity: 0;
  animation: fadeUp 0.8s ease forwards 1s;
}

.stat {
  text-align: right;
}

.stat-num {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 700;
  color: var(--amber);
  line-height: 1;
}

.stat-label {
  font-size: 0.7rem;
  color: var(--text-dim);
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

/* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
section {
  padding: 6rem 3rem;
  max-width: 1200px;
  margin: 0 auto;
}

.section-tag {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--amber);
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 1rem;
}

.section-title {
  font-family: var(--font-display);
  font-size: clamp(1.8rem, 3.5vw, 3rem);
  font-weight: 700;
  line-height: 1.15;
  letter-spacing: -0.01em;
  margin-bottom: 1.5rem;
}

.section-intro {
  font-size: 1rem;
  color: var(--text-muted);
  max-width: 600px;
  margin-bottom: 3.5rem;
}

.divider {
  width: 100%;
  height: 1px;
  background: var(--border);
  margin: 0;
}

/* ‚îÄ‚îÄ FRAMEWORK ‚îÄ‚îÄ */
#framework { padding-top: 7rem; }

.pillars {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1px;
  background: var(--border);
  border: 1px solid var(--border);
  margin-bottom: 2rem;
}

.pillar-card {
  background: var(--surface);
  padding: 2.5rem 2rem;
  position: relative;
  overflow: hidden;
  transition: background 0.3s;
}

.pillar-card:hover { background: var(--surface2); }

.pillar-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
}

.pillar-card.transit::before { background: var(--blue); }
.pillar-card.demo::before { background: var(--green); }
.pillar-card.poi::before { background: var(--gold); }

.pillar-num {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text-dim);
  letter-spacing: 0.15em;
  margin-bottom: 1rem;
}

.pillar-icon {
  font-size: 1.8rem;
  margin-bottom: 1rem;
  display: block;
}

.pillar-name {
  font-family: var(--font-display);
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.pillar-weight {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--amber);
  margin-bottom: 1rem;
}

.pillar-desc {
  font-size: 0.85rem;
  color: var(--text-muted);
  line-height: 1.6;
}

.pillar-vars {
  margin-top: 1.2rem;
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.pillar-var {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  padding: 0.3rem 0.6rem;
  background: var(--bg);
  border-left: 2px solid var(--border);
}

.gap-card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 2rem;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  align-items: center;
  margin-bottom: 3rem;
}

.gap-formula {
  font-family: var(--font-mono);
  font-size: 0.9rem;
  color: var(--text);
  line-height: 2;
}

.gap-formula .op { color: var(--amber); }
.gap-formula .val { color: var(--green); }

.gap-legend {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.gap-item {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
}

.gap-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  margin-top: 0.4rem;
  flex-shrink: 0;
}

.gap-item-text { font-size: 0.85rem; color: var(--text-muted); }
.gap-item-label { font-weight: 500; color: var(--text); font-size: 0.9rem; }

/* ‚îÄ‚îÄ DECISION MATRIX ‚îÄ‚îÄ */
.matrix {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto auto auto;
  gap: 1px;
  background: var(--border);
  border: 1px solid var(--border);
  margin-top: 3rem;
}

.matrix-header {
  background: var(--surface);
  padding: 1rem 1.5rem;
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  text-align: center;
}

.matrix-label {
  background: var(--surface);
  padding: 1rem 1.5rem;
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  justify-content: center;
  writing-mode: horizontal-tb;
  grid-column: span 2;
  text-align: center;
  border-top: 1px solid var(--border);
}

.matrix-cell {
  background: var(--surface);
  padding: 1.8rem;
  transition: background 0.2s;
}

.matrix-cell:hover { background: var(--surface2); }

.matrix-tag {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 0.6rem;
}

.matrix-cell h4 {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.matrix-cell p {
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.tag-opportunity { color: var(--amber); }
.tag-strong { color: var(--green); }
.tag-risk { color: var(--red); }
.tag-watch { color: var(--blue); }

/* ‚îÄ‚îÄ EXPLORER ‚îÄ‚îÄ */
#explorer {
  max-width: 100%;
  padding: 6rem 3rem;
}

.explorer-inner {
  max-width: 1200px;
  margin: 0 auto;
}

.explorer-layout {
  display: grid;
  grid-template-columns: 340px 1fr;
  gap: 0;
  border: 1px solid var(--border);
  height: 680px;
}

.explorer-panel {
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.panel-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.panel-title {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-bottom: 0.3rem;
}

.panel-subtitle {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.panel-body {
  padding: 1.5rem;
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

/* View toggle */
.view-toggle {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--border);
  border: 1px solid var(--border);
}

.toggle-btn {
  background: var(--surface);
  border: none;
  color: var(--text-muted);
  padding: 0.6rem;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
}

.toggle-btn.active {
  background: var(--amber);
  color: #0e0e0e;
  font-weight: 500;
}

/* Sliders */
.sliders-section { display: flex; flex-direction: column; gap: 1.2rem; }

.slider-group { display: flex; flex-direction: column; gap: 0.5rem; }

.slider-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.slider-label {
  font-size: 0.78rem;
  color: var(--text);
  font-weight: 500;
}

.slider-value {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--amber);
}

.slider-desc {
  font-size: 0.7rem;
  color: var(--text-dim);
}

input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  height: 2px;
  background: var(--border);
  outline: none;
  cursor: pointer;
}

input[type=range].transit { accent-color: var(--blue); }
input[type=range].transit::-webkit-slider-thumb { background: var(--blue); }
input[type=range].demo { accent-color: var(--green); }
input[type=range].demo::-webkit-slider-thumb { background: var(--green); }
input[type=range].poi { accent-color: var(--gold); }
input[type=range].poi::-webkit-slider-thumb { background: var(--gold); }

input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px; height: 14px;
  border-radius: 50%;
  cursor: pointer;
}

.weight-total {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  padding: 0.5rem 0.8rem;
  border: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.weight-total.ok { border-color: var(--green); color: var(--green); }
.weight-total.warn { border-color: var(--red); color: var(--red); }

.reset-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 0.5rem;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
  width: 100%;
  transition: all 0.2s;
}

.reset-btn:hover { border-color: var(--amber); color: var(--amber); }

/* Tract card */
.tract-card {
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 1.2rem;
  display: none;
  flex-direction: column;
  gap: 0.8rem;
}

.tract-card.visible { display: flex; }

.tract-neighbourhood {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
}

.tract-geoid {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text-dim);
}

.tract-scores { display: flex; flex-direction: column; gap: 0.5rem; }

.score-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.78rem;
}

.score-label { color: var(--text-muted); }
.score-val {
  font-family: var(--font-mono);
  font-size: 0.78rem;
  font-weight: 500;
}

.score-bar-wrap {
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 2px;
}

.score-bar {
  height: 100%;
  border-radius: 2px;
  transition: width 0.4s ease;
}

.tract-diagnosis {
  background: var(--surface2);
  border-left: 2px solid var(--amber);
  padding: 0.8rem;
  font-size: 0.78rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.tract-diagnosis strong { color: var(--text); }

.tract-placeholder {
  background: var(--bg);
  border: 1px dashed var(--border);
  padding: 1.5rem;
  text-align: center;
  font-size: 0.8rem;
  color: var(--text-dim);
  line-height: 1.6;
}

/* Map */
.map-container { position: relative; }
#map { height: 680px; width: 100%; }

.map-legend {
  position: absolute;
  bottom: 1.5rem;
  right: 1.5rem;
  background: rgba(14,14,14,0.92);
  border: 1px solid var(--border);
  padding: 1rem 1.2rem;
  z-index: 999;
  min-width: 140px;
}

.legend-title {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text-dim);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 0.8rem;
}

.legend-items { display: flex; flex-direction: column; gap: 0.4rem; }

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  font-size: 0.72rem;
  color: var(--text-muted);
}

.legend-swatch {
  width: 24px; height: 8px;
  border-radius: 1px;
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ FINDINGS ‚îÄ‚îÄ */
.findings-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1px;
  background: var(--border);
  border: 1px solid var(--border);
}

.finding-card {
  background: var(--surface);
  padding: 2rem;
  transition: background 0.2s;
}

.finding-card:hover { background: var(--surface2); }

.finding-num {
  font-family: var(--font-mono);
  font-size: 2rem;
  font-weight: 500;
  color: var(--amber-dim);
  line-height: 1;
  margin-bottom: 1rem;
}

.finding-card h3 {
  font-family: var(--font-display);
  font-size: 1.05rem;
  font-weight: 700;
  margin-bottom: 0.6rem;
  line-height: 1.3;
}

.finding-card p {
  font-size: 0.82rem;
  color: var(--text-muted);
  line-height: 1.6;
}

/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.82rem;
  margin-bottom: 2rem;
}

.data-table th {
  background: var(--surface);
  padding: 0.8rem 1rem;
  text-align: left;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text-dim);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
}

.data-table td {
  padding: 0.8rem 1rem;
  border-bottom: 1px solid var(--border);
  color: var(--text-muted);
  vertical-align: top;
}

.data-table td:first-child { color: var(--text); font-weight: 400; }

.data-table tr:last-child td { border-bottom: none; }
.data-table tr:hover td { background: var(--surface); }

.table-title {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 1rem;
  margin-top: 2rem;
}

/* Tract tables */
.tract-table-wrap {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-top: 2rem;
}

.mini-table { border: 1px solid var(--border); }

.mini-table-header {
  background: var(--surface);
  padding: 0.8rem 1rem;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text-dim);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
}

.mini-table-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.7rem 1rem;
  border-bottom: 1px solid var(--border);
  font-size: 0.8rem;
  transition: background 0.15s;
}

.mini-table-row:last-child { border-bottom: none; }
.mini-table-row:hover { background: var(--surface); }

.mini-row-name { color: var(--text); }
.mini-row-score {
  font-family: var(--font-mono);
  font-size: 0.75rem;
}

/* ‚îÄ‚îÄ REPLICATE ‚îÄ‚îÄ */
.checklist { display: flex; flex-direction: column; gap: 1px; background: var(--border); border: 1px solid var(--border); }

.checklist-row {
  display: grid;
  grid-template-columns: 180px 1fr 1fr 180px;
  background: var(--surface);
  transition: background 0.15s;
}

.checklist-row:hover { background: var(--surface2); }

.checklist-row.header {
  background: var(--bg);
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text-dim);
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

.checklist-cell {
  padding: 1rem 1.2rem;
  border-right: 1px solid var(--border);
  font-size: 0.8rem;
  line-height: 1.5;
}

.checklist-cell:last-child { border-right: none; }
.checklist-cell strong { color: var(--text); display: block; margin-bottom: 0.2rem; }
.checklist-cell .sub { color: var(--text-dim); font-size: 0.72rem; font-family: var(--font-mono); }

.checklist-status {
  display: inline-block;
  padding: 0.15rem 0.5rem;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.05em;
  border-radius: 2px;
}

.status-free { background: rgba(90,155,110,0.15); color: var(--green); }
.status-easy { background: rgba(201,168,76,0.15); color: var(--gold); }

/* ‚îÄ‚îÄ LIMITATIONS ‚îÄ‚îÄ */
.limitations-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1px;
  background: var(--border);
  border: 1px solid var(--border);
}

.limit-card {
  background: var(--surface);
  padding: 1.8rem;
}

.limit-icon { font-size: 1.2rem; margin-bottom: 0.8rem; display: block; }
.limit-card h4 { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; }
.limit-card p { font-size: 0.78rem; color: var(--text-muted); line-height: 1.5; }

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
footer {
  border-top: 1px solid var(--border);
  padding: 2.5rem 3rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.footer-text {
  font-size: 0.75rem;
  color: var(--text-dim);
}

.footer-links {
  display: flex;
  gap: 1.5rem;
}

.footer-links a {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  text-decoration: none;
  letter-spacing: 0.05em;
  transition: color 0.2s;
}

.footer-links a:hover { color: var(--amber); }

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.reveal {
  opacity: 0;
  transform: translateY(24px);
  transition: opacity 0.7s ease, transform 0.7s ease;
}

.reveal.visible {
  opacity: 1;
  transform: translateY(0);
}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); }

/* ‚îÄ‚îÄ LEAFLET OVERRIDES ‚îÄ‚îÄ */
.leaflet-container { background: #0e0e0e; }
.leaflet-control-zoom a {
  background: var(--surface) !important;
  color: var(--text) !important;
  border-color: var(--border) !important;
}
.leaflet-control-attribution {
  background: rgba(14,14,14,0.8) !important;
  color: var(--text-dim) !important;
  font-size: 9px !important;
}
.leaflet-control-attribution a { color: var(--text-dim) !important; }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <span class="nav-logo">UCDT ‚Äî v1.0</span>
  <ul class="nav-links">
    <li><a href="#framework">Framework</a></li>
    <li><a href="#explorer">Explorer</a></li>
    <li><a href="#findings">Findings</a></li>
    <li><a href="#replicate">Replicate</a></li>
  </ul>
</nav>

<!-- HERO -->
<div class="hero">
  <div class="hero-grid"></div>
  <div class="hero-glow"></div>
  <div class="hero-content">
    <p class="hero-tag">Urban Commercial Diagnostic Toolkit</p>
    <h1>Where should <em>commercial</em> investment go?</h1>
    <p class="hero-sub">A spatial framework for assessing neighbourhood-level commercial conditions ‚Äî built from open data, designed to be replicated in any city.</p>
    <div class="hero-cta">
      <a href="#explorer" class="btn-primary">Explore Boston</a>
      <a href="#replicate" class="btn-secondary">Replicate this</a>
    </div>
  </div>
  <div class="hero-stats">
    <div class="stat">
      <div class="stat-num">205</div>
      <div class="stat-label">Census Tracts</div>
    </div>
    <div class="stat">
      <div class="stat-num">3</div>
      <div class="stat-label">Index Pillars</div>
    </div>
    <div class="stat">
      <div class="stat-num">100%</div>
      <div class="stat-label">Open Data</div>
    </div>
  </div>
</div>

<div class="divider"></div>

<!-- FRAMEWORK -->
<section id="framework">
  <p class="section-tag reveal">01 / Framework</p>
  <h2 class="section-title reveal">A three-pillar model for<br>commercial viability</h2>
  <p class="section-intro reveal">Most location decisions rely on comparable transactions or gut instinct. This toolkit provides a systematic, evidence-based alternative using three dimensions of neighbourhood-level data.</p>

  <div class="pillars reveal">
    <div class="pillar-card transit">
      <div class="pillar-num">PILLAR 01</div>
      <span class="pillar-icon">üöá</span>
      <div class="pillar-name">Transit Access</div>
      <div class="pillar-weight">Default weight: 35%</div>
      <div class="pillar-desc">Measures how reachable a neighbourhood is by public transport. High transit access generates consistent foot traffic ‚Äî the lifeblood of commercial activity.</div>
      <div class="pillar-vars">
        <div class="pillar-var">Transit stop count (log-scaled)</div>
        <div class="pillar-var">Rapid transit presence flag</div>
      </div>
    </div>
    <div class="pillar-card demo">
      <div class="pillar-num">PILLAR 02</div>
      <span class="pillar-icon">üë•</span>
      <div class="pillar-name">Demographic Catchment</div>
      <div class="pillar-weight">Default weight: 35%</div>
      <div class="pillar-desc">Measures the spending potential of the resident population. Combines market size, income levels, and the share of the population in peak commercial spending years.</div>
      <div class="pillar-vars">
        <div class="pillar-var">Median household income</div>
        <div class="pillar-var">Total population</div>
        <div class="pillar-var">Share aged 25-54</div>
      </div>
    </div>
    <div class="pillar-card poi">
      <div class="pillar-num">PILLAR 03</div>
      <span class="pillar-icon">üè™</span>
      <div class="pillar-name">POI Density</div>
      <div class="pillar-weight">Default weight: 30%</div>
      <div class="pillar-desc">Measures existing commercial activity using an inverted-U curve. Moderate density scores highest ‚Äî too little means no market has formed, too much signals oversaturation.</div>
      <div class="pillar-vars">
        <div class="pillar-var">Commercial POI count (log-scaled)</div>
        <div class="pillar-var">Inverted-U scoring (peak at 60th pct)</div>
      </div>
    </div>
  </div>

  <div class="gap-card reveal">
    <div>
      <p class="section-tag" style="margin-bottom:0.8rem">Market Gap Score</p>
      <h3 style="font-family:var(--font-display);font-size:1.3rem;margin-bottom:0.8rem">Where demand outpaces supply</h3>
      <p style="font-size:0.85rem;color:var(--text-muted);line-height:1.6;margin-bottom:1.2rem">The gap score surfaces the most actionable insight: neighbourhoods where demand fundamentals are strong but commercial supply has not caught up. These are the opportunity zones.</p>
      <div class="gap-formula">
        <span class="val">Demand</span> = avg(Pillar 1, Pillar 2)<br>
        <span class="val">Supply</span> = POI density (linear)<br>
        <span class="op">Gap</span> = Demand <span class="op">-</span> Supply<br>
        <span style="color:var(--text-dim);font-size:0.8rem">Rescaled -100 to +100</span>
      </div>
    </div>
    <div class="gap-legend">
      <div class="gap-item">
        <div class="gap-dot" style="background:var(--amber)"></div>
        <div>
          <div class="gap-item-label">Positive gap (+)</div>
          <div class="gap-item-text">Demand exceeds supply. Strong population and transit fundamentals with thin commercial presence. Investment opportunity.</div>
        </div>
      </div>
      <div class="gap-item">
        <div class="gap-dot" style="background:var(--blue)"></div>
        <div>
          <div class="gap-item-label">Negative gap (-)</div>
          <div class="gap-item-text">Supply exceeds demand. High commercial density relative to residential catchment. Elevated competition risk for new entrants.</div>
        </div>
      </div>
      <div class="gap-item">
        <div class="gap-dot" style="background:var(--text-dim)"></div>
        <div>
          <div class="gap-item-label">Near zero</div>
          <div class="gap-item-text">Demand and supply are broadly in balance. Monitor for changes in demographics or commercial development.</div>
        </div>
      </div>
    </div>
  </div>

  <p class="section-tag reveal" style="margin-bottom:1rem">Interpretation guide</p>
  <h3 style="font-family:var(--font-display);font-size:1.3rem;margin-bottom:0.5rem;margin-top:0" class="reveal">How to read the outputs</h3>
  <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:0" class="reveal">Combine CVI score and gap score to determine the right action for each neighbourhood.</p>

  <div class="matrix reveal">
    <div class="matrix-header" style="border-right:1px solid var(--border)">High Gap Score (Underserved)</div>
    <div class="matrix-header">Low Gap Score (Saturated)</div>
    <div class="matrix-cell">
      <div class="matrix-tag tag-opportunity">Prime Opportunity</div>
      <h4>Strong fundamentals, unmet demand</h4>
      <p>High viability + underserved. Best conditions for new commercial investment. Prioritise for site selection and commercial lending.</p>
    </div>
    <div class="matrix-cell">
      <div class="matrix-tag tag-strong">Established Market</div>
      <h4>Strong fundamentals, mature market</h4>
      <p>High viability + saturated. Market is working. Focus on quality differentiation rather than entry. Good for established operators.</p>
    </div>
    <div class="matrix-cell">
      <div class="matrix-tag tag-watch">Latent Opportunity</div>
      <h4>Weak fundamentals, thin supply</h4>
      <p>Low viability + underserved. Supply is thin but so is demand. Investigate why ‚Äî infrastructure gap? Demographic shift underway? Monitor closely.</p>
    </div>
    <div class="matrix-cell">
      <div class="matrix-tag tag-risk">High Risk</div>
      <h4>Weak fundamentals, oversupplied</h4>
      <p>Low viability + saturated. Worst conditions for new investment. High competition, weak demand catchment. Avoid for new commercial development.</p>
    </div>
    <div class="matrix-label">‚Üê High CVI &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Low CVI ‚Üí</div>
  </div>
</section>

<div class="divider"></div>

<!-- EXPLORER -->
<div id="explorer" style="padding: 6rem 0 0;">
  <div class="explorer-inner" style="padding: 0 3rem;">
    <p class="section-tag reveal">02 / Boston Case Study</p>
    <h2 class="section-title reveal">Explore the data</h2>
    <p class="section-intro reveal">Adjust the pillar weights to reflect your city's context. Click any tract to see a diagnosis. Switch between CVI and Gap Score views.</p>
  </div>
  <div style="padding: 0 3rem 2rem;">
    <div class="explorer-layout reveal">
      <!-- Panel -->
      <div class="explorer-panel">
        <div class="panel-header">
          <div class="panel-title">Controls</div>
          <div class="panel-subtitle">Adjust weights, explore tracts</div>
        </div>
        <div class="panel-body">

          <!-- View toggle -->
          <div>
            <div style="font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:0.5rem">Map View</div>
            <div class="view-toggle">
              <button class="toggle-btn active" id="btn-cvi" onclick="setView('cvi')">CVI Score</button>
              <button class="toggle-btn" id="btn-gap" onclick="setView('gap')">Gap Score</button>
            </div>
          </div>

          <!-- Sliders -->
          <div class="sliders-section">
            <div style="font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);letter-spacing:0.1em;text-transform:uppercase">Pillar Weights</div>

            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">üöá Transit Access</span>
                <span class="slider-value" id="val-transit">35%</span>
              </div>
              <input type="range" class="transit" id="w-transit" min="0" max="100" value="35" oninput="updateWeights()"/>
              <span class="slider-desc">Stop count + rapid transit flag</span>
            </div>

            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">üë• Demographics</span>
                <span class="slider-value" id="val-demo">35%</span>
              </div>
              <input type="range" class="demo" id="w-demo" min="0" max="100" value="35" oninput="updateWeights()"/>
              <span class="slider-desc">Income, population, age 25-54</span>
            </div>

            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">üè™ POI Density</span>
                <span class="slider-value" id="val-poi">30%</span>
              </div>
              <input type="range" class="poi" id="w-poi" min="0" max="100" value="30" oninput="updateWeights()"/>
              <span class="slider-desc">Commercial density (inverted-U)</span>
            </div>

            <div class="weight-total ok" id="weight-total">
              <span>Total weight</span>
              <span id="total-val">100%</span>
            </div>

            <button class="reset-btn" onclick="resetWeights()">Reset to defaults</button>
          </div>

          <!-- Tract card -->
          <div>
            <div style="font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:0.5rem">Tract Diagnosis</div>
            <div class="tract-card" id="tract-card">
              <div>
                <div class="tract-neighbourhood" id="tc-neighbourhood"></div>
                <div class="tract-geoid" id="tc-geoid"></div>
              </div>
              <div class="tract-scores" id="tc-scores"></div>
              <div class="tract-diagnosis" id="tc-diagnosis"></div>
            </div>
            <div class="tract-placeholder" id="tract-placeholder">
              Click any tract on the map to see a detailed diagnosis and score breakdown.
            </div>
          </div>

        </div>
      </div>
      <!-- Map -->
      <div class="map-container" style="position:relative;">
        <div id="map"></div>
        <div class="map-legend" id="map-legend">
          <div class="legend-title" id="legend-title">CVI Score</div>
          <div class="legend-items" id="legend-items"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FINDINGS -->
<section id="findings">
  <p class="section-tag reveal">03 / Key Findings</p>
  <h2 class="section-title reveal">What Boston's data shows</h2>
  <p class="section-intro reveal">Five findings from applying the toolkit to 205 Boston census tracts.</p>

  <div class="findings-grid reveal">
    <div class="finding-card">
      <div class="finding-num">01</div>
      <h3>Commercial viability concentrates along transit corridors</h3>
      <p>The highest CVI scores align with the MBTA rapid transit network ‚Äî particularly the Orange Line through Dorchester and the Green Line through Brighton and Jamaica Plain. Transit access is the sharpest differentiator between high and low-scoring tracts.</p>
    </div>
    <div class="finding-card">
      <div class="finding-num">02</div>
      <h3>The most underserved tracts combine transit with thin supply</h3>
      <p>Mission Hill and Mattapan both score above 63 on the gap score with only 1 POI each, yet have 5-7 transit stops and resident populations above 2,800. These represent genuine unmet demand that existing supply has not caught up with.</p>
    </div>
    <div class="finding-card">
      <div class="finding-num">03</div>
      <h3>Downtown tracts appear oversaturated on residential metrics alone</h3>
      <p>Chinatown, Allston, and the North End score -88 to -100 on the gap score. This reflects a limitation: supply is measured against residential demographics only. Daytime population is not captured, so employment-dense areas appear more oversaturated than they are in practice.</p>
    </div>
    <div class="finding-card">
      <div class="finding-num">04</div>
      <h3>POI density and transit access are spatially decoupled</h3>
      <p>High transit access does not reliably predict high commercial density. Several tracts with strong transit scores have very low POI counts ‚Äî these are the underserved opportunity zones the gap analysis surfaces. The two pillars provide independent information.</p>
    </div>
    <div class="finding-card">
      <div class="finding-num">05</div>
      <h3>Demographic catchment is relatively uniform across the city</h3>
      <p>Pillar 2 shows less spatial variation than Pillars 1 or 3. Boston's residential income and population are distributed broadly enough that demographics alone is a weak differentiator ‚Äî transit and existing market conditions are the stronger signals.</p>
    </div>
    <div class="finding-card">
      <div class="finding-num" style="color:var(--amber-dim)">‚Üí</div>
      <h3>Top tracts by CVI score</h3>
      <div style="margin-top:0.5rem">
        <div class="mini-table">
          <div class="mini-table-header">Highest commercial viability</div>
          <div class="mini-table-row"><span class="mini-row-name">Dorchester</span><span class="mini-row-score" style="color:var(--amber)">100.0</span></div>
          <div class="mini-table-row"><span class="mini-row-name">Charlestown</span><span class="mini-row-score" style="color:var(--amber)">96.0</span></div>
          <div class="mini-table-row"><span class="mini-row-name">Jamaica Plain</span><span class="mini-row-score" style="color:var(--amber)">93.9</span></div>
          <div class="mini-table-row"><span class="mini-row-name">South Boston</span><span class="mini-row-score" style="color:var(--amber)">92.3</span></div>
          <div class="mini-table-row"><span class="mini-row-name">Brighton</span><span class="mini-row-score" style="color:var(--amber)">90.3</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="tract-table-wrap reveal">
    <div class="mini-table">
      <div class="mini-table-header" style="background:rgba(212,133,74,0.1);color:var(--amber)">Most underserved (demand > supply)</div>
      <div class="mini-table-row">
        <span class="mini-row-name">Mission Hill</span>
        <span class="mini-row-score" style="color:var(--amber)">+64.4</span>
      </div>
      <div class="mini-table-row">
        <span class="mini-row-name">Mattapan</span>
        <span class="mini-row-score" style="color:var(--amber)">+63.7</span>
      </div>
      <div class="mini-table-row">
        <span class="mini-row-name">Dorchester</span>
        <span class="mini-row-score" style="color:var(--amber)">+52.7</span>
      </div>
      <div class="mini-table-row">
        <span class="mini-row-name">Brighton</span>
        <span class="mini-row-score" style="color:var(--amber)">+40.8</span>
      </div>
      <div class="mini-table-row">
        <span class="mini-row-name">Jamaica Plain</span>
        <span class="mini-row-score" style="color:var(--amber)">+37.9</span>
      </div>
    </div>
    <div class="mini-table">
      <div class="mini-table-header" style="background:rgba(74,122,181,0.1);color:var(--blue)">Most oversaturated (supply > demand)</div>
      <div class="mini-table-row">
        <span class="mini-row-name">Chinatown</span>
        <span class="mini-row-score" style="color:var(--blue)">-100.0</span>
      </div>
      <div class="mini-table-row">
        <span class="mini-row-name">Allston</span>
        <span class="mini-row-score" style="color:var(--blue)">-96.4</span>
      </div>
      <div class="mini-table-row">
        <span class="mini-row-name">North End</span>
        <span class="mini-row-score" style="color:var(--blue)">-90.6</span>
      </div>
      <div class="mini-table-row">
        <span class="mini-row-name">East Boston</span>
        <span class="mini-row-score" style="color:var(--blue)">-88.8</span>
      </div>
      <div class="mini-table-row">
        <span class="mini-row-name">Allston</span>
        <span class="mini-row-score" style="color:var(--blue)">-88.0</span>
      </div>
    </div>
  </div>
</section>

<div class="divider"></div>

<!-- REPLICATE -->
<section id="replicate">
  <p class="section-tag reveal">04 / Replicate This</p>
  <h2 class="section-title reveal">Apply this in your city</h2>
  <p class="section-intro reveal">This toolkit was built entirely from open data. Here is everything you need to replicate it ‚Äî with local equivalents for cities outside the US.</p>

  <div class="checklist reveal">
    <div class="checklist-row header">
      <div class="checklist-cell">Data Layer</div>
      <div class="checklist-cell">US Source (Boston)</div>
      <div class="checklist-cell">Non-US Equivalent</div>
      <div class="checklist-cell">Format / Notes</div>
    </div>
    <div class="checklist-row">
      <div class="checklist-cell">
        <strong>Administrative boundaries</strong>
        <span class="sub">Census tract or equivalent</span>
      </div>
      <div class="checklist-cell">
        Census TIGER/Line<br>
        <span class="sub">pygris.tracts()</span>
        <br><span class="checklist-status status-free">Free</span>
      </div>
      <div class="checklist-cell">
        National statistics agency shapefile. Malaysia: DOSM. UK: ONS. Indonesia: BPS. Any polygon unit works ‚Äî ward, mukim, subdistrict.
      </div>
      <div class="checklist-cell">
        <span class="sub">GeoPackage or Shapefile. Reproject to local CRS before analysis.</span>
      </div>
    </div>
    <div class="checklist-row">
      <div class="checklist-cell">
        <strong>Demographics</strong>
        <span class="sub">Income, population, age</span>
      </div>
      <div class="checklist-cell">
        American Community Survey<br>
        <span class="sub">pygris.data.get_census()</span>
        <br><span class="checklist-status status-free">Free</span>
      </div>
      <div class="checklist-cell">
        Malaysia: Population and Housing Census (DOSM). UK: Census 2021 (ONS). Singapore: SingStat. Any source with income and age at sub-district level.
      </div>
      <div class="checklist-cell">
        <span class="sub">CSV joined to boundaries on common ID. Age bands will differ by country ‚Äî adjust the 25-54 grouping accordingly.</span>
      </div>
    </div>
    <div class="checklist-row">
      <div class="checklist-cell">
        <strong>Transit stops</strong>
        <span class="sub">Bus, rail, metro locations</span>
      </div>
      <div class="checklist-cell">
        MBTA GTFS static feed<br>
        <span class="sub">cdn.mbta.com/MBTA_GTFS.zip</span>
        <br><span class="checklist-status status-free">Free</span>
      </div>
      <div class="checklist-cell">
        Most transit agencies publish GTFS feeds. Find yours at transitfeeds.com or mobilitydata.org. Malaysia: Prasarana GTFS. Singapore: LTA DataMall.
      </div>
      <div class="checklist-cell">
        <span class="sub">Parse stops.txt for coordinates. Join to routes to filter by mode (bus=3, subway=1, rail=2).</span>
      </div>
    </div>
    <div class="checklist-row">
      <div class="checklist-cell">
        <strong>Commercial POIs</strong>
        <span class="sub">Retail, F&B, services, offices</span>
      </div>
      <div class="checklist-cell">
        OpenStreetMap via osmnx<br>
        <span class="sub">ox.features_from_place()</span>
        <br><span class="checklist-status status-free">Free</span>
      </div>
      <div class="checklist-cell">
        OSM works globally ‚Äî coverage varies by city. High quality in KL, Singapore, Jakarta. Supplement with Google Places API or Foursquare if coverage is thin.
      </div>
      <div class="checklist-cell">
        <span class="sub">Tags: shop=*, amenity=[restaurant, cafe, bank], office=*. Convert polygon footprints to centroids before spatial join.</span>
      </div>
    </div>
  </div>

  <div style="margin-top:3rem" class="reveal">
    <p class="section-tag" style="margin-bottom:1rem">Key methodology decisions</p>
    <table class="data-table">
      <thead>
        <tr>
          <th>Decision</th>
          <th>What we did</th>
          <th>Why</th>
          <th>Alternatives</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>POI count transformation</td>
          <td>log1p before scoring</td>
          <td>Raw distribution: median 8, max 236. Without log-transform, downtown dominates and everything else collapses to near-zero.</td>
          <td>Square root transform. Winsorise at 95th percentile. Either works ‚Äî log is most common for count data.</td>
        </tr>
        <tr>
          <td>POI density scoring</td>
          <td>Inverted-U curve, peak at 60th percentile</td>
          <td>Moderate density is commercially optimal ‚Äî too little means no market, too much means oversaturation.</td>
          <td>Linear scoring (simpler but misses oversaturation signal). Adjust peak percentile based on your city's POI distribution.</td>
        </tr>
        <tr>
          <td>Transit scoring</td>
          <td>60% stop count + 40% rapid transit flag</td>
          <td>59% of Boston tracts have zero stops inside their boundary. Raw count alone collapses most of the city to zero.</td>
          <td>Walking-time isochrones from stops (more accurate, more complex). Buffer-based approach (stops within 500m of tract centroid).</td>
        </tr>
        <tr>
          <td>Null income imputation</td>
          <td>Median imputation (14 tracts)</td>
          <td>Dropping null tracts creates holes in the map. Median is conservative and defensible.</td>
          <td>Spatial interpolation from neighbouring tracts. Model-based imputation.</td>
        </tr>
        <tr>
          <td>Age band selection</td>
          <td>25-54 as peak commercial cohort</td>
          <td>Standard retail analytics assumption ‚Äî stable income, active discretionary spending.</td>
          <td>Adjust for local context. In a student-heavy city, extend to 20-54. In an ageing city, extend to 65+.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="limitations-grid reveal" style="margin-top:3rem">
    <div class="limit-card">
      <span class="limit-icon">‚ö†Ô∏è</span>
      <h4>Residential demographics only</h4>
      <p>Daytime population (workers, students, visitors) is not captured. Downtown and employment-dense areas will appear more oversaturated than they are in practice.</p>
    </div>
    <div class="limit-card">
      <span class="limit-icon">üó∫Ô∏è</span>
      <h4>OSM coverage varies</h4>
      <p>OpenStreetMap data quality depends on community contribution. Coverage is strong in major Southeast Asian cities but may be thin in smaller towns.</p>
    </div>
    <div class="limit-card">
      <span class="limit-icon">üìç</span>
      <h4>Point-in-polygon transit</h4>
      <p>Transit access is measured by stops inside the tract boundary, not walking-time isochrones. A tract with no stops may still be well-served by stops in adjacent tracts.</p>
    </div>
    <div class="limit-card">
      <span class="limit-icon">üí∞</span>
      <h4>No market pricing data</h4>
      <p>Commercial vacancy rates, rental prices, and lease availability are not included. These would significantly sharpen investment recommendations.</p>
    </div>
    <div class="limit-card">
      <span class="limit-icon">üìÖ</span>
      <h4>Static snapshot</h4>
      <p>The index reflects conditions at a single point in time. Rapid development, rezoning, or infrastructure changes can alter scores significantly within 1-2 years.</p>
    </div>
    <div class="limit-card">
      <span class="limit-icon">‚öñÔ∏è</span>
      <h4>Weight calibration needed</h4>
      <p>Default weights (35/35/30) reflect Boston's context. Cities with underdeveloped transit or higher income inequality may need significantly different weightings.</p>
    </div>
  </div>
</section>

<div class="divider"></div>

<!-- FOOTER -->
<footer>
  <div class="footer-text">
    Urban Commercial Diagnostic Toolkit ¬∑ Boston case study ¬∑ Built with open data
  </div>
  <div class="footer-links">
    <a href="https://github.com/IrfanTajuddin" target="_blank">GitHub</a>
    <a href="#framework">Back to top</a>
  </div>
</footer>

<script>
// ‚îÄ‚îÄ DATA & STATE ‚îÄ‚îÄ
let geojsonData = null;
let map = null;
let geojsonLayer = null;
let currentView = 'cvi';
let weights = { transit: 35, demo: 35, poi: 30 };

// ‚îÄ‚îÄ COLOUR SCALES ‚îÄ‚îÄ
const CVI_COLOURS = ['#1a1a2e','#2d2d4e','#8b4513','#c94040','#d4854a','#e8c56a'];
const GAP_COLOURS = {
  pos: ['#e8d5c0','#d4854a','#8b3a0f'],
  neg: ['#c0d5e8','#4a7ab5','#1a3a5e'],
  zero: '#2a2a2a'
};

function getCVIColour(score) {
  if (score === null || score === undefined) return '#1a1a1a';
  const t = score / 100;
  const stops = [
    [0,   '#161616'],
    [0.2, '#2a1810'],
    [0.4, '#6b3010'],
    [0.6, '#c94040'],
    [0.8, '#d4854a'],
    [1.0, '#e8c56a']
  ];
  for (let i = 1; i < stops.length; i++) {
    if (t <= stops[i][0]) {
      const lo = stops[i-1], hi = stops[i];
      const frac = (t - lo[0]) / (hi[0] - lo[0]);
      return lerpColour(lo[1], hi[1], frac);
    }
  }
  return stops[stops.length-1][1];
}

function getGapColour(score) {
  if (score === null || score === undefined) return '#1a1a1a';
  if (Math.abs(score) < 5) return '#2a2a2a';
  if (score > 0) {
    const t = Math.min(score / 65, 1);
    return lerpColour('#2d1a0a', '#d4854a', t);
  } else {
    const t = Math.min(Math.abs(score) / 100, 1);
    return lerpColour('#0a1a2d', '#4a7ab5', t);
  }
}

function lerpColour(hex1, hex2, t) {
  const r1 = parseInt(hex1.slice(1,3),16), g1 = parseInt(hex1.slice(3,5),16), b1 = parseInt(hex1.slice(5,7),16);
  const r2 = parseInt(hex2.slice(1,3),16), g2 = parseInt(hex2.slice(3,5),16), b2 = parseInt(hex2.slice(5,7),16);
  const r = Math.round(r1 + (r2-r1)*t);
  const g = Math.round(g1 + (g2-g1)*t);
  const b = Math.round(b1 + (b2-b1)*t);
  return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}

// ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ
function recomputeCVI(props, w) {
  const total = w.transit + w.demo + w.poi;
  if (total === 0) return 0;
  const wt = w.transit / total;
  const wd = w.demo / total;
  const wp = w.poi / total;
  return (wt * props.pillar1_transit + wd * props.pillar2_demographics + wp * props.pillar3_poi_density) * 100;
}

// ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ
function initMap() {
  map = L.map('map', {
    center: [42.3201, -71.0789],
    zoom: 12,
    zoomControl: true,
    attributionControl: true
  });

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '¬© OpenStreetMap ¬© CARTO',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);
}

// ‚îÄ‚îÄ LAYER ‚îÄ‚îÄ
function renderLayer() {
  if (!geojsonData || !map) return;

  if (geojsonLayer) {
    map.removeLayer(geojsonLayer);
  }

  geojsonLayer = L.geoJSON(geojsonData, {
    style: feature => {
      const props = feature.properties;
      let colour;
      if (currentView === 'cvi') {
        const score = recomputeCVI(props, weights);
        colour = getCVIColour(score);
      } else {
        colour = getGapColour(props.gap_score);
      }
      return {
        fillColor: colour,
        fillOpacity: 0.82,
        color: '#0e0e0e',
        weight: 0.8,
        opacity: 1
      };
    },
    onEachFeature: (feature, layer) => {
      layer.on({
        mouseover: e => {
          e.target.setStyle({ weight: 2, color: '#d4854a', fillOpacity: 0.95 });
        },
        mouseout: e => {
          geojsonLayer.resetStyle(e.target);
        },
        click: e => showTractCard(feature.properties)
      });
    }
  }).addTo(map);

  updateLegend();
}

// ‚îÄ‚îÄ TRACT CARD ‚îÄ‚îÄ
function showTractCard(props) {
  const card = document.getElementById('tract-card');
  const placeholder = document.getElementById('tract-placeholder');

  const cvi = recomputeCVI(props, weights);
  const gap = props.gap_score;
  const neighbourhood = props.neighborhood || 'Unknown';

  document.getElementById('tc-neighbourhood').textContent = neighbourhood;
  document.getElementById('tc-geoid').textContent = `Tract ${props.GEOID}`;

  const scoresHtml = `
    <div class="score-row">
      <span class="score-label">CVI Score</span>
      <span class="score-val" style="color:var(--amber)">${cvi.toFixed(1)}</span>
    </div>
    <div class="score-bar-wrap"><div class="score-bar" style="width:${cvi}%;background:var(--amber)"></div></div>

    <div class="score-row" style="margin-top:0.4rem">
      <span class="score-label">üöá Transit</span>
      <span class="score-val" style="color:var(--blue)">${(props.pillar1_transit*100).toFixed(0)}</span>
    </div>
    <div class="score-bar-wrap"><div class="score-bar" style="width:${props.pillar1_transit*100}%;background:var(--blue)"></div></div>

    <div class="score-row" style="margin-top:0.4rem">
      <span class="score-label">üë• Demographics</span>
      <span class="score-val" style="color:var(--green)">${(props.pillar2_demographics*100).toFixed(0)}</span>
    </div>
    <div class="score-bar-wrap"><div class="score-bar" style="width:${props.pillar2_demographics*100}%;background:var(--green)"></div></div>

    <div class="score-row" style="margin-top:0.4rem">
      <span class="score-label">üè™ POI Density</span>
      <span class="score-val" style="color:var(--gold)">${(props.pillar3_poi_density*100).toFixed(0)}</span>
    </div>
    <div class="score-bar-wrap"><div class="score-bar" style="width:${props.pillar3_poi_density*100}%;background:var(--gold)"></div></div>

    <div class="score-row" style="margin-top:0.6rem;padding-top:0.6rem;border-top:1px solid var(--border)">
      <span class="score-label">Gap Score</span>
      <span class="score-val" style="color:${gap > 0 ? 'var(--amber)' : 'var(--blue)'}">${gap > 0 ? '+' : ''}${gap.toFixed(1)}</span>
    </div>
    <div class="score-row" style="font-size:0.72rem;color:var(--text-dim)">
      <span>${props.total_stops} transit stops ¬∑ ${props.total_pois} POIs ¬∑ Pop. ${(props.total_population||0).toLocaleString()}</span>
    </div>
  `;

  document.getElementById('tc-scores').innerHTML = scoresHtml;
  document.getElementById('tc-diagnosis').innerHTML = getDiagnosis(props, cvi, gap);

  card.classList.add('visible');
  placeholder.style.display = 'none';
}

function getDiagnosis(props, cvi, gap) {
  const highCVI = cvi >= 50;
  const highGap = gap > 15;
  const lowGap = gap < -15;

  if (highCVI && highGap) {
    return `<strong>Prime Opportunity.</strong> Strong viability fundamentals with unmet commercial demand. This tract has the transit access and demographic catchment to support new commercial activity ‚Äî but current supply is thin. Prioritise for site selection or commercial lending assessment.`;
  } else if (highCVI && lowGap) {
    return `<strong>Established Market.</strong> Strong fundamentals and an active commercial scene. The market is working here. Better suited for established operators seeking proven locations than for new entrants seeking undersupplied markets.`;
  } else if (highCVI && !highGap && !lowGap) {
    return `<strong>Balanced Market.</strong> Good viability with supply roughly matching demand. A stable commercial environment. Monitor for shifts in transit investment or demographic change that could open opportunities.`;
  } else if (!highCVI && highGap) {
    return `<strong>Latent Opportunity.</strong> Commercial supply is thin but so are demand fundamentals. Worth investigating why ‚Äî is there a planned transit investment nearby? A demographic shift underway? Low viability today doesn't rule out future opportunity.`;
  } else if (!highCVI && lowGap) {
    return `<strong>High Risk.</strong> Weak demand fundamentals combined with high existing commercial density. Poor conditions for new commercial investment. High competition, limited catchment, and limited upside.`;
  } else {
    return `<strong>Watch.</strong> Mixed signals ‚Äî moderate viability and relatively balanced supply-demand. Not a priority intervention zone, but worth monitoring as conditions evolve.`;
  }
}

// ‚îÄ‚îÄ LEGEND ‚îÄ‚îÄ
function updateLegend() {
  const title = document.getElementById('legend-title');
  const items = document.getElementById('legend-items');

  if (currentView === 'cvi') {
    title.textContent = 'CVI Score';
    items.innerHTML = `
      <div class="legend-item"><div class="legend-swatch" style="background:#e8c56a"></div>High (75-100)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#d4854a"></div>Good (50-75)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#c94040"></div>Moderate (25-50)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#2a1810"></div>Low (0-25)</div>
    `;
  } else {
    title.textContent = 'Gap Score';
    items.innerHTML = `
      <div class="legend-item"><div class="legend-swatch" style="background:#d4854a"></div>Underserved (+)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#2a2a2a"></div>Balanced (~0)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#4a7ab5"></div>Oversaturated (-)</div>
    `;
  }
}

// ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ
function setView(view) {
  currentView = view;
  document.getElementById('btn-cvi').classList.toggle('active', view === 'cvi');
  document.getElementById('btn-gap').classList.toggle('active', view === 'gap');
  renderLayer();
}

function updateWeights() {
  weights.transit = parseInt(document.getElementById('w-transit').value);
  weights.demo = parseInt(document.getElementById('w-demo').value);
  weights.poi = parseInt(document.getElementById('w-poi').value);

  document.getElementById('val-transit').textContent = weights.transit + '%';
  document.getElementById('val-demo').textContent = weights.demo + '%';
  document.getElementById('val-poi').textContent = weights.poi + '%';

  const total = weights.transit + weights.demo + weights.poi;
  const totalEl = document.getElementById('weight-total');
  const totalVal = document.getElementById('total-val');
  totalVal.textContent = total + '%';
  totalEl.className = 'weight-total ' + (total === 100 ? 'ok' : 'warn');

  renderLayer();
}

function resetWeights() {
  document.getElementById('w-transit').value = 35;
  document.getElementById('w-demo').value = 35;
  document.getElementById('w-poi').value = 30;
  updateWeights();
}

// ‚îÄ‚îÄ SCROLL REVEAL ‚îÄ‚îÄ
function initReveal() {
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
      }
    });
  }, { threshold: 0.1 });

  document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
}

// ‚îÄ‚îÄ LOAD DATA ‚îÄ‚îÄ
async function loadData() {
  try {
    const response = await fetch('cvi_scored_web.geojson');
    if (!response.ok) throw new Error('GeoJSON not found');
    geojsonData = await response.json();
    renderLayer();
  } catch(e) {
    console.error('Could not load GeoJSON:', e);
    document.getElementById('map').innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:1rem;color:var(--text-muted);font-size:0.85rem;padding:2rem;text-align:center;">
        <div style="font-size:2rem">üìÇ</div>
        <div>Place <code style="font-family:var(--font-mono);color:var(--amber)">cvi_scored_web.geojson</code> in the same folder as this HTML file to load the map.</div>
        <div style="color:var(--text-dim);font-size:0.75rem">Generated by notebook 01 in the project repository.</div>
      </div>
    `;
  }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  initMap();
  loadData();
  initReveal();
});
</script>
</body>
</html>
